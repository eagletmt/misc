From 991fe75ae81904aaefadcc1108da700a879988aa Mon Sep 17 00:00:00 2001
From: Kohei Suzuki <eagletmt@gmail.com>
Date: Sat, 25 Jan 2014 17:35:27 +0900
Subject: [PATCH 2/2] Autoload images

---
 src/article/articleview.cpp | 28 ++++++++++++++++++++++++++++
 src/article/drawareabase.h  |  2 ++
 src/article/layouttree.cpp  |  4 ++--
 src/article/layouttree.h    |  4 ++--
 4 files changed, 34 insertions(+), 4 deletions(-)

diff --git a/src/article/articleview.cpp b/src/article/articleview.cpp
index a374d09..90c9bda 100644
--- a/src/article/articleview.cpp
+++ b/src/article/articleview.cpp
@@ -13,6 +13,9 @@
 
 #include "dbtree/interface.h"
 #include "dbtree/articlebase.h"
+#include "dbtree/node.h"
+
+#include "dbimg/imginterface.h"
 
 #include "jdlib/miscutil.h"
 #include "jdlib/misctime.h"
@@ -566,6 +569,31 @@ void ArticleViewMain::update_finish()
 
     if( m_show_instdialog ) show_instruct_diag();
 
+    if( number_new > 0 && m_set_history ){
+        const bool open_imageview = CONFIG::get_use_image_view();
+        const bool mosaic = CONFIG::get_use_mosaic();
+        const LayoutTree* layout_tree = drawarea()->layout_tree();
+        const LAYOUT* layout = layout_tree->get_header_of_res_const( number_load - number_new + 1 );
+        bool first = true;
+        while( layout ){
+            const LAYOUT* next_header = layout->next_header;
+            while( layout ){
+                if( layout->type == DBTREE::NODE_LINK && layout->node && layout->node->linkinfo && layout->node->linkinfo->imglink ){
+                    const std::string url( layout->node->linkinfo->imglink );
+                    const int res_number = layout->res_number;
+                    const std::string refurl = DBTREE::url_readcgi( url_article(), res_number, 0 );
+                    if( ! DBIMG::is_cached( url ) ){
+                        DBIMG::download_img_wait( url, refurl, mosaic, first );
+                        first = false;
+                    }
+                    if( open_imageview ) CORE::core_set_command( "open_image", url );
+              }
+              layout = layout->next_layout;
+            }
+            layout = next_header;
+        }
+    }
+
     if( m_show_closedialog && !number_load && is_old() ){
 
         SKELETON::MsgDiag mdiag( get_parent_win(), "DAT落ちしたためスレッドを取得できませんでした。\n\nタブを閉じますか？",
diff --git a/src/article/drawareabase.h b/src/article/drawareabase.h
index c01fbc2..271e636 100644
--- a/src/article/drawareabase.h
+++ b/src/article/drawareabase.h
@@ -317,6 +317,8 @@ namespace ARTICLE
         void live_stop();
         void update_live_speed( const int sec );
 
+        const LayoutTree* layout_tree() const { return m_layout_tree; }
+
       protected:
 
         // リアライズしたか
diff --git a/src/article/layouttree.cpp b/src/article/layouttree.cpp
index d31358a..ecf498d 100644
--- a/src/article/layouttree.cpp
+++ b/src/article/layouttree.cpp
@@ -547,9 +547,9 @@ void LayoutTree::append_dat( const std::string& dat, int num )
 //
 // レス番号 number のヘッダを返す
 //
-const LAYOUT* LayoutTree::get_header_of_res_const( const int number ){ return get_header_of_res( number ); }
+const LAYOUT* LayoutTree::get_header_of_res_const( const int number ) const { return get_header_of_res( number ); }
 
-LAYOUT* LayoutTree::get_header_of_res( const int number )
+LAYOUT* LayoutTree::get_header_of_res( const int number ) const
 {
     if( ! m_vec_header ) return NULL;
     if( number > m_max_res_number || number <= 0 ) return NULL;
diff --git a/src/article/layouttree.h b/src/article/layouttree.h
index 127481b..2913e05 100644
--- a/src/article/layouttree.h
+++ b/src/article/layouttree.h
@@ -142,8 +142,8 @@ namespace ARTICLE
         void append_dat( const std::string& dat, int num );
 
         // レス番号 number のヘッダを返す
-        const LAYOUT* get_header_of_res_const( const int number );
-        LAYOUT* get_header_of_res( const int number );
+        const LAYOUT* get_header_of_res_const( const int number ) const;
+        LAYOUT* get_header_of_res( const int number ) const;
 
         // 新着セパレータ移動
         // set_separator_new()にレス番号をセットしてからmove_separator()を呼ぶ
-- 
1.8.5.3

